{% extends 'layouts/app.html' %}

{% block content %}

<div class="container mt-4">
    <h1>Dashboard: {{ request.user.username }}</h1>
    <div class="mb-3">
        <a href="#" class="btn btn-dark" id="logout-btn">Logout</a>
        <button id="end-session-btn" class="btn btn-primary">End Session and Generate Prescription</button>
    </div>
    <!-- Chatbot Interface -->
    <div class="chatbot-wrapper mt-4">
        <div class="chatbox border rounded p-3">
            <div class="chatbox-header border-bottom mb-2">
                <h5 class="mb-0">Chatbot</h5>
            </div>
            <div class="chatbox-body overflow-auto" style="height: 400px;">
                <!-- Messages will be displayed here -->
                <div class="message">
                    <div class="d-flex">
                        <div class="chatbot-message bg-primary text-white p-2 rounded" id="initial-message">
                            {{ initial_message|safe }}
                        </div>
                    </div>
                </div>
                <!-- More messages can be added dynamically -->
            </div>
            <div class="chatbox-footer border-top pt-2">
                <form id="chat-form">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type your health status..." id="message-input" required>
                        <button class="btn btn-primary" type="submit">Send</button>
                        <button id="start-recording" class="btn btn-secondary">Start Recording</button>
                        <button id="stop-recording" class="btn btn-secondary" disabled>Stop Recording</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Time Slot Selection -->
<div class="modal fade" id="timeSlotModal" tabindex="-1" aria-labelledby="timeSlotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="timeSlotModalLabel">Select a Time Slot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="time-slot-form">
                    <div class="mb-3">
                        <label for="time-slot" class="form-label">Choose a time slot for your in-person appointment:</label>
                        <select class="form-select" id="time-slot" required>
                            <!-- Time slots will be dynamically populated by JavaScript -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Book Appointment</button>
                    <button type="button" class="btn btn-secondary" id="opt-out-btn">No, I don't want an appointment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS for Chatbot -->
<style>
.chatbot-wrapper {
    position: relative;
    max-width: 600px;
    margin: auto;
}

.chatbox {
    position: relative;
    background-color: #f8f9fa;
}

.chatbox-body {
    background-color: #ffffff;
    padding: 15px;
    border-radius: 5px;
    overflow-y: scroll;
}

.message {
    margin-bottom: 10px;
}

.chatbot-message {
    max-width: 75%;
    word-break: break-word;
}

.chatbot-message.bg-secondary {
    background-color: #6c757d;
}

.chatbot-message.bg-primary {
    background-color: #007bff;
}
</style>

<!-- JavaScript for Chat Functionality -->
<script>
    let mediaRecorder;
    let audioChunks = [];
    document.getElementById('start-recording').addEventListener('click', startRecording);
    document.getElementById('stop-recording').addEventListener('click', stopRecording);
    function endSessionAndGeneratePrescription() {
        fetch("{% url 'end_session_and_generate_prescription' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
        })
        .then(response => {
            if (response.ok) {
                const disposition = response.headers.get('Content-Disposition');
                const filename = disposition.match(/filename="(.+)"/)[1];
                return response.blob().then(blob => ({ blob, filename }));
            } else {
                return response.json().then(data => {
                    throw new Error(data.message || "An error occurred. Please try again.");
                });
            }
        })
        .then(({ blob, filename }) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;  // Use the filename from the response
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            alert("Prescription generated successfully.");
        })
        .catch(error => {
            console.error('Error:', error);
            alert("An error occurred. Please try again.");
            document.getElementById('end-session-btn').disabled = false;
        });
    }

    function startRecording(e) {
    e.preventDefault();
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            document.getElementById('start-recording').disabled = true;
            document.getElementById('stop-recording').disabled = false;
        });
}

    function stopRecording(e) {
        e.preventDefault();
        mediaRecorder.stop();
        document.getElementById('start-recording').disabled = false;
        document.getElementById('stop-recording').disabled = true;

        mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioChunks = [];
            sendAudioToServer(audioBlob);
        });
    }

    function sendAudioToServer(audioBlob) {
        const formData = new FormData();
        formData.append("audio", audioBlob, "recording.webm");

        fetch("{% url 'speech_to_text' %}", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.text) {
                document.getElementById('message-input').value = data.text;
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            } else if (data.error) {
                console.error('Error:', data.error);
                alert('Error processing speech: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your speech.');
        });
    }


    function textToSpeech(text) {
        fetch("{% url 'text_to_speech' %}", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ text: text })
        })
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play();
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }


document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatBody = document.querySelector('.chatbox-body');
    const endSessionBtn = document.getElementById('end-session-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const timeSlotModal = new bootstrap.Modal(document.getElementById('timeSlotModal'));
    const timeSlotForm = document.getElementById('time-slot-form');
    const optOutBtn = document.getElementById('opt-out-btn');

    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            appendMessage('user', message);
            messageInput.value = '';
            sendMessageToServer(message);
        }
    });

    endSessionBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to end the session and generate the prescription?')) {
            endSessionBtn.disabled = true;
            endSessionAndGeneratePrescription();
        }
    });

    logoutBtn.addEventListener('click', function(event) {
        event.preventDefault();
        populateTimeSlots();
        timeSlotModal.show();
    });

    timeSlotForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const selectedTimeSlot = document.getElementById('time-slot').value;
        bookAppointment(selectedTimeSlot);
    });

    optOutBtn.addEventListener('click', function() {
        window.location.href = "{% url 'logout' %}";
    });

    function appendMessage(sender, messageContent) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        const messageInnerDiv = document.createElement('div');
        messageInnerDiv.classList.add('d-flex', sender === 'user' ? 'justify-content-end' : 'justify-content-start');
        const messageBubble = document.createElement('div');
        messageBubble.classList.add('chatbot-message', 'p-2', 'rounded');
        if (sender === 'bot') {
        const speakButton = document.createElement('button');
        speakButton.textContent = 'Speak';
        speakButton.classList.add('btn', 'btn-sm', 'btn-secondary', 'ml-2');
        speakButton.addEventListener('click', () => {
            textToSpeech(messageContent);
            speakButton.disabled=true});
        messageInnerDiv.appendChild(speakButton);
         }
        if (sender === 'user') {
            messageBubble.classList.add('bg-secondary');
            messageBubble.classList.add('text-white');
        } else {
            messageBubble.classList.add('bg-primary');
            messageBubble.classList.add('text-white');
        }
        messageBubble.innerHTML = messageContent;
        messageInnerDiv.appendChild(messageBubble);
        messageDiv.appendChild(messageInnerDiv);
        chatBody.appendChild(messageDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function sendMessageToServer(message) {
        fetch("{% url 'chatbot_response' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            appendMessage('bot', data.response);
        })
        .catch(error => {
            console.error('Error:', error);
            appendMessage('bot', 'Sorry, an error occurred while processing your message.');
        });
    }

    function populateTimeSlots() {
        const timeSlotSelect = document.getElementById('time-slot');
        timeSlotSelect.innerHTML = ''; // Clear existing options

        const now = new Date();
        const nextDay = new Date(now);
        nextDay.setDate(now.getDate() + 1);

        const options = [
            { time: '12:00 PM - 12:30 PM', label: `12:00 PM - 12:30 PM on ${nextDay.toDateString()}` },
            { time: '12:30 PM - 1:00 PM', label: `12:30 PM - 1:00 PM on ${nextDay.toDateString()}` },
            { time: '1:00 PM - 1:30 PM', label: `1:00 PM - 1:30 PM on ${nextDay.toDateString()}` }
        ];

        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option.time;
            opt.textContent = option.label;
            timeSlotSelect.appendChild(opt);
        });
    }

    function bookAppointment(timeSlot) {
        fetch("{% url 'book_appointment' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ time_slot: timeSlot })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert("Your in-person appointment has been booked at your desired time.");
                window.location.href = "{% url 'login' %}";
            } else {
                alert(data.message || "An error occurred. Please try again.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("An error occurred. Please try again.");
        });
    }
});
</script>

{% endblock %}